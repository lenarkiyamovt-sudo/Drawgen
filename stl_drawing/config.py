"""
Центральный модуль констант и конфигурации.

Все магические числа собраны здесь с объяснением их роли.
"""

from enum import Enum
from typing import Dict, Optional

import numpy as np


# ---------------------------------------------------------------------------
# ГОСТ 2.303-68 — Типы линий ЕСКД (ESKDLineType)
# ---------------------------------------------------------------------------

class ESKDLineType(Enum):
    """Типы линий чертежа по ГОСТ 2.303-68.

    Каждый тип содержит абсолютные значения:
      - stroke_width: толщина линии в мм
      - pattern: SVG stroke-dasharray (None для сплошных)
      - desc: описание по ГОСТ
      - priority: приоритет отрисовки (меньше = поверх)
      - is_wave: флаг волнистой линии (опционально)
    """
    # Сплошная основная — видимый контур
    # Реальная толщина S определяется адаптивно в gost_params; здесь — дефолт
    SOLID = {
        "stroke_width": 0.7,
        "pattern": None,
        "desc": "Сплошная основная",
        "priority": 2,
    }
    # Сплошная тонкая — размерные, выносные линии
    THIN = {
        "stroke_width": 0.25,
        "pattern": None,
        "desc": "Сплошная тонкая",
        "priority": 1,
    }
    # Штриховая — невидимый контур
    # Реальные параметры (толщина, штрихи) определяются адаптивно в gost_params
    DASHED = {
        "stroke_width": 0.28,
        "pattern": "4,1.5",
        "desc": "Штриховая",
        "priority": 3,
    }
    # Штрихпунктирная тонкая — осевые, центровые линии
    # Реальные параметры определяются адаптивно в gost_params
    CENTER = {
        "stroke_width": 0.28,
        "pattern": "10,3,1,3",
        "desc": "Осевая",
        "priority": 0,
    }
    # Штрихпунктирная с двумя точками — сгибы развёрток
    DOTTED = {
        "stroke_width": 0.3,
        "pattern": "5,2,1,2",
        "desc": "Штрихпунктирная",
        "priority": 4,
    }
    # Сплошная волнистая — линии обрыва
    WAVELINE = {
        "stroke_width": 0.3,
        "pattern": None,
        "desc": "Волнистая",
        "is_wave": True,
        "priority": 5,
    }
    # Разомкнутая — линии сечений
    SECTION = {
        "stroke_width": 0.7,
        "pattern": None,
        "desc": "Разомкнутая",
        "priority": 6,
    }
    # Рамка — основная линия рамки
    FRAME = {
        "stroke_width": 0.5,
        "pattern": None,
        "desc": "Линия рамки",
        "priority": 10,
    }
    # Рамка тонкая — внешняя граница листа
    FRAME_THIN = {
        "stroke_width": 0.18,
        "pattern": None,
        "desc": "Тонкая линия рамки",
        "priority": 10,
    }
    # Штамп — линии штампа тонкие
    STAMP_THIN = {
        "stroke_width": 0.18,
        "pattern": None,
        "desc": "Тонкая линия штампа",
        "priority": 10,
    }

    @property
    def stroke_width(self) -> float:
        """Толщина линии в мм (абсолютное значение)."""
        return self.value["stroke_width"]

    @property
    def svg_pattern(self) -> Optional[str]:
        """SVG stroke-dasharray или None для сплошной."""
        return self.value.get("pattern")

    @property
    def description(self) -> str:
        """Описание типа линии по ГОСТ."""
        return self.value["desc"]

    @property
    def draw_priority(self) -> int:
        """Приоритет отрисовки (меньше = поверх)."""
        return self.value["priority"]

    @property
    def is_wavy(self) -> bool:
        """True для волнистой линии."""
        return self.value.get("is_wave", False)

    def get_svg_style(self, color: str = "black") -> Dict[str, str]:
        """Получить SVG-атрибуты стиля для данного типа линии.

        Args:
            color: цвет линии

        Returns:
            Словарь SVG-атрибутов
        """
        style = {
            "stroke": color,
            "stroke-width": f"{self.stroke_width}mm",
            "stroke-linecap": "butt",
        }
        if self.svg_pattern:
            style["stroke-dasharray"] = self.svg_pattern
        return style

# ---------------------------------------------------------------------------
# Точность геометрических вычислений
# ---------------------------------------------------------------------------

#: Размер ячейки сетки для квантизации кэша видимости
GRID_SIZE: float = 1e-4

#: Минимальная разница глубины (Z), при которой грань считается перекрывающей точку
EPS_DEPTH: float = 1e-6

#: Минимальная длина сегмента 2D-ребра, ниже которой сегмент отбрасывается
EPS_SEGMENT: float = 1e-4

#: Минимальная длина ребра 3D-сетки (рёбра короче игнорируются)
MIN_EDGE_LENGTH: float = 1e-5

# ---------------------------------------------------------------------------
# Классификация острых рёбер
# ---------------------------------------------------------------------------

#: Угол между нормалями граней, при котором ребро считается острым (градусы)
SHARP_ANGLE_DEGREES: float = 10.0

#: cos(SHARP_ANGLE_DEGREES) — используется для сравнения dot-product нормалей
SHARP_ANGLE_COS: float = np.cos(np.radians(SHARP_ANGLE_DEGREES))

# ---------------------------------------------------------------------------
# Адаптивная дискретизация рёбер (видимость)
# ---------------------------------------------------------------------------

#: Базовая глубина рекурсии adaptive_sampling
BASE_MAX_RECURSION_DEPTH: int = 3

# ---------------------------------------------------------------------------
# Флаги включения/выключения этапов обработки
# ---------------------------------------------------------------------------

#: Включить слияние коллинеарных отрезков
ENABLE_MERGE: bool = True

#: Включить приоритет стилей (видимые перекрывают скрытые)
ENABLE_PRIORITY: bool = True

#: Включить фильтр острых рёбер (отключить = wireframe)
ENABLE_SHARP_EDGES: bool = True

# ---------------------------------------------------------------------------
# Компоновка чертежа
# ---------------------------------------------------------------------------

#: Расстояние между видами на листе (мм)
VIEW_SPACING_MM: float = 30.0

#: Число зазоров по горизонтали в 6-видовой схеме: right|front|left|back
N_GAPS_HORIZONTAL: int = 3

#: Число зазоров по вертикали: bottom|front|top (ЕСКД, метод 1-го угла)
N_GAPS_VERTICAL: int = 2

# ---------------------------------------------------------------------------
# Алгоритм выбора необходимого набора видов
# ---------------------------------------------------------------------------

#: Коэффициент подобия Жаккара (0..1): выше → виды считаются зеркальными
VIEW_SIMILARITY_THRESHOLD: float = 0.85

#: Если score вида < этой доли от лучшего в паре — вид исключается
VIEW_SCORE_RATIO_MIN: float = 0.3

#: Минимальный информационный score для «непустого» вида
VIEW_MIN_INFO_SCORE: float = 2.0

#: Вес скрытого ребра в информационном score (visible = 1.0)
VIEW_HIDDEN_EDGE_WEIGHT: float = 0.3

#: Порог PCA: OBB/AABB объём — ниже означает, что PCA улучшила ориентацию
OBB_GAIN_THRESHOLD: float = 0.95

# ---------------------------------------------------------------------------
# ГОСТ 2.301-68 — стандартные форматы листов (короткая × длинная сторона, мм)
# ---------------------------------------------------------------------------

GOST_FORMATS: dict = {
    'A4': (210, 297),
    'A3': (297, 420),
    'A2': (420, 594),
    'A1': (594, 841),
    'A0': (841, 1189),
}

GOST_FORMATS_ORDERED: list = ['A4', 'A3', 'A2', 'A1', 'A0']

# ---------------------------------------------------------------------------
# ГОСТ 2.302-68 — стандартные масштабы уменьшения (отсортированы по убыванию)
# ---------------------------------------------------------------------------

GOST_REDUCTION_SCALES: list = [
    1.0,       # 1:1
    0.5,       # 1:2
    1.0/2.5,   # 1:2.5
    0.25,      # 1:4
    0.2,       # 1:5
    0.1,       # 1:10
    1.0/15,    # 1:15
    0.05,      # 1:20
    1.0/25,    # 1:25
    1.0/40,    # 1:40
    0.02,      # 1:50
    1.0/75,    # 1:75
    0.01,      # 1:100
    1.0/200,   # 1:200
    1.0/400,   # 1:400
    1.0/500,   # 1:500
    1.0/800,   # 1:800
    0.001,     # 1:1000
]

# ---------------------------------------------------------------------------
# ГОСТ 2.104-2006 — поля и рамка чертежа (мм)
# ---------------------------------------------------------------------------

MARGIN_LEFT: float = 20.0    # левое поле (корешок)
MARGIN_OTHER: float = 5.0    # остальные поля
TITLE_BLOCK_W: float = 185.0  # ширина основной надписи
TITLE_BLOCK_H: float = 55.0   # высота основной надписи

#: Минимальный размер главного вида на листе (мм) — для читаемости чертежа
MIN_MAIN_VIEW_MM: float = 40.0

# ---------------------------------------------------------------------------
# ГОСТ 2.303-68 — толщины линий (мм)
# ---------------------------------------------------------------------------

#: Толщина основной линии видов для «мелких» чертежей (главный вид < 80 мм)
S_THIN_DRAWING: float = 0.5

#: Толщина основной линии видов для «крупных» чертежей (главный вид ≥ 80 мм)
S_THICK_DRAWING: float = 0.7

#: Постоянная толщина линий рамки и штампа (не зависит от масштаба)
#: OpenSCAD оригинал: s=0.25, основная линия штампа = 0.25 мм
S_FRAME: float = 0.25

# ---------------------------------------------------------------------------
# ГОСТ 2.304-81 — шрифт надписей в штампе
# ---------------------------------------------------------------------------

#: Высота шрифта в штампе (мм), тип Б — ГОСТ 2.304-81
#: 1.4 мм соответствует оригиналу (OpenSCAD font_size=1.4)
STAMP_FONT_H: float = 1.4

#: Семейство шрифта для штампа и надписей чертежа (ГОСТ 2.304-81)
#: GOST Common — стандартный ЕСКД-шрифт, ISOCPEUR — AutoCAD-аналог
STAMP_FONT_FAMILY: str = "GOST Common, ISOCPEUR, Arial, sans-serif"

# ---------------------------------------------------------------------------
# ГОСТ 2.307-2011 — размеры и размерные линии
# ---------------------------------------------------------------------------

#: Длина стрелки размерной линии (мм) — fallback-значение.
#: Реальное значение вычисляется в gost_params: 6×S (ГОСТ 2.307-2011, рис. 25)
DIM_ARROW_LENGTH: float = 3.0

#: Ширина стрелки размерной линии (мм) — fallback-значение.
#: Реальное значение вычисляется в gost_params: 2×S (ГОСТ 2.307-2011, рис. 25)
DIM_ARROW_WIDTH: float = 1.0

#: Высота шрифта размерных надписей (мм) — fallback-значение.
#: Реальное значение вычисляется в gost_params: 3.5 при S≤0.5, 5.0 при S≥0.7
DIM_TEXT_HEIGHT: float = 3.5

#: Зазор между текстом и размерной линией (мм)
DIM_TEXT_GAP: float = 1.0

#: Расстояние от контура до первой размерной линии (мм)
DIM_FIRST_OFFSET: float = 10.0

#: Расстояние между последующими размерными линиями (мм)
DIM_NEXT_OFFSET: float = 7.0

#: Выступ выносной линии за размерную линию (мм)
DIM_EXTENSION_OVERSHOOT: float = 2.0

#: Зазор между контуром детали и началом выносной линии (мм)
DIM_EXTENSION_GAP: float = 1.5

#: Минимальный размер на бумаге для отображения (мм) — мельче не показываем
DIM_MIN_DISPLAYABLE: float = 4.0

#: Семейство шрифта для размерных надписей (ГОСТ 2.304-81 тип Б наклонный)
DIM_FONT_FAMILY: str = "GOST Common, ISOCPEUR"

#: Резерв пространства на листе для размерных линий (мм с каждой стороны)
DIM_MARGIN_RESERVE: float = 25.0

# ---------------------------------------------------------------------------
# ГОСТ 2.307-2011 — адаптивные стрелки размерных линий
# ---------------------------------------------------------------------------

#: Порог «стрелки наружу» (мм на бумаге): при расстоянии между выносными
#: меньше этого — стрелки размещаются снаружи (ГОСТ 2.307-2011 п.5.2)
#: Должен быть ≥ 2 × arrow_length + запас на текст
DIM_ARROWS_OUTSIDE_THRESHOLD: float = 10.0

#: Порог «точки вместо стрелок» (мм на бумаге): при расстоянии ещё меньше —
#: вместо стрелок/засечек ставятся точки, текст на выноске
DIM_DOT_THRESHOLD: float = 2.0

#: Длина засечки 45° (мм) — используется когда стрелки не помещаются
DIM_TICK_LENGTH: float = 2.0

#: Радиус точки-маркера (мм) — используется при очень малых размерах
DIM_DOT_RADIUS: float = 0.4

#: Горизонтальный участок линии-выноски (мм) — полка для текста
DIM_LEADER_HORIZONTAL: float = 5.0

#: Порог радиуса (мм модели) для отображения R вместо Ø
#: Цилиндры с радиусом ≤ порога показываются как R (скругления, фаски, мелкие отверстия)
DIM_RADIUS_THRESHOLD: float = 8.0
